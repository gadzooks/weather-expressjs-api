name: Post Deployment Summary
description: Create a workflow summary comment for deployment status
inputs:
  environment:
    description: Environment name
    required: true
  status:
    description: Deployment status
    required: true
  api_url:
    description: API URL
    required: false
  diff_message:
    description: Diff message for production
    required: false

runs:
  using: composite
  steps:
    - name: Create Summary
      uses: actions/github-script@v7
      with:
        script: |
          const environment = '${{ inputs.environment }}';
          const status = '${{ inputs.status }}';
          const apiUrl = '${{ inputs.api_url }}';
          const diffMessage = `${{ inputs.diff_message }}`;

          const emoji = status === 'success' ? 'âœ…' : 'âŒ';
          const envEmoji = {
            'dev': 'ğŸ”§',
            'qa': 'ğŸ§ª',
            'production': 'ğŸš€'
          }[environment] || 'ğŸ“¦';

          let message = `## ${emoji} ${envEmoji} ${environment.toUpperCase()} Deployment ${status}\n\n`;
          message += `**Commit:** ${context.sha}\n`;
          message += `**Workflow:** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;

          if (apiUrl) {
            message += `**API URL:** ${apiUrl}\n\n`;
          }

          if (diffMessage) {
            message += `\n${diffMessage}\n`;
          }

          // Post comment based on context
          // For PRs: use issue comment (requires pull-requests: write)
          // For non-PRs: use commit comment (requires contents: write)
          if (context.issue && context.issue.number) {
            // We're in a PR context - post as issue comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
          } else {
            // Not in PR context - post as commit comment
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });
          }
